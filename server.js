//const _0x362ad4=_0x2c3d;(function(_0x5685ee,_0x2649b0){const _0x19428c=_0x2c3d,_0x5d66cb=_0x5685ee();while(!![]){try{const _0x531da8=-parseInt(_0x19428c(0xa8))/0x1+parseInt(_0x19428c(0xbc))/0x2+-parseInt(_0x19428c(0xbd))/0x3+-parseInt(_0x19428c(0xb4))/0x4+-parseInt(_0x19428c(0xa6))/0x5*(parseInt(_0x19428c(0xb2))/0x6)+parseInt(_0x19428c(0xd0))/0x7*(-parseInt(_0x19428c(0xb5))/0x8)+parseInt(_0x19428c(0xa1))/0x9*(parseInt(_0x19428c(0xac))/0xa);if(_0x531da8===_0x2649b0)break;else _0x5d66cb['push'](_0x5d66cb['shift']());}catch(_0x5e773c){_0x5d66cb['push'](_0x5d66cb['shift']());}}}(_0x4c8d,0x4157f));function hi(){const _0x2a0858=_0x2c3d;console[_0x2a0858(0xb6)](_0x2a0858(0xc5));}hi();const _0x21180=_0x4a76;(function(_0x25430d,_0x37f2bb){const _0x3afb17=_0x2c3d,_0x9364c7=_0x4a76,_0x4cf06e=_0x25430d();while(!![]){try{const _0x9ef4c8=-parseInt(_0x9364c7(0x144))/0x1+parseInt(_0x9364c7(0x16b))/0x2+-parseInt(_0x9364c7(0x148))/0x3*(parseInt(_0x9364c7(0x135))/0x4)+parseInt(_0x9364c7(0x146))/0x5*(parseInt(_0x9364c7(0x161))/0x6)+-parseInt(_0x9364c7(0x15d))/0x7*(-parseInt(_0x9364c7(0x155))/0x8)+-parseInt(_0x9364c7(0x156))/0x9*(-parseInt(_0x9364c7(0x160))/0xa)+-parseInt(_0x9364c7(0x173))/0xb*(-parseInt(_0x9364c7(0x14a))/0xc);if(_0x9ef4c8===_0x37f2bb)break;else _0x4cf06e[_0x3afb17(0xab)](_0x4cf06e[_0x3afb17(0xbb)]());}catch(_0x29cc47){_0x4cf06e['push'](_0x4cf06e['shift']());}}}(_0x1a81,0xf053d));function _0x2c3d(_0x264f37,_0x3394c3){const _0x4c8d82=_0x4c8d();return _0x2c3d=function(_0x2c3d30,_0x19bcc3){_0x2c3d30=_0x2c3d30-0x98;let _0xe8ee21=_0x4c8d82[_0x2c3d30];return _0xe8ee21;},_0x2c3d(_0x264f37,_0x3394c3);}function hi(){const _0x16bddd=_0x4a76;console[_0x16bddd(0x172)](_0x16bddd(0x170));}function _0x1a81(){const _0x4936ca=_0x2c3d,_0x50766d=[_0x4936ca(0xb1),'/api/search',_0x4936ca(0x9c),_0x4936ca(0xa9),_0x4936ca(0x9b),_0x4936ca(0xc5),_0x4936ca(0xa5),_0x4936ca(0xb6),'407QTAKKx',_0x4936ca(0x9d),_0x4936ca(0xcd),_0x4936ca(0xd8),'mp3','message',_0x4936ca(0xdb),_0x4936ca(0x9e),'success',_0x4936ca(0xa4),'duration',_0x4936ca(0x9a),_0x4936ca(0xb9),_0x4936ca(0xcc),_0x4936ca(0xd2),_0x4936ca(0xad),_0x4936ca(0xce),'pipe','PORT',_0x4936ca(0xc0),'audio/mpeg','author',_0x4936ca(0xa7),_0x4936ca(0xdc),_0x4936ca(0x9f),'Server\x20running\x20on\x20http://localhost:',_0x4936ca(0xc2),_0x4936ca(0xc4),'305652PrezBb','https://apis.davidcyriltech.my.id/download/ytmp3?url=',_0x4936ca(0xd9),_0x4936ca(0xda),_0x4936ca(0xaa),_0x4936ca(0xc8),'error',_0x4936ca(0xba),_0x4936ca(0xc1),_0x4936ca(0xd6),'Preview\x20error:',_0x4936ca(0xa3),_0x4936ca(0xb7),_0x4936ca(0xd1),_0x4936ca(0xcb),_0x4936ca(0xa0),_0x4936ca(0xca),_0x4936ca(0xaf),_0x4936ca(0xd3),_0x4936ca(0xb0),_0x4936ca(0xc9),_0x4936ca(0xcf),_0x4936ca(0xd5),'174zpmqWH',_0x4936ca(0xc7),'items',_0x4936ca(0xd7),_0x4936ca(0xdd),_0x4936ca(0xc6),_0x4936ca(0xd4),_0x4936ca(0xb8),_0x4936ca(0xae),_0x4936ca(0xbf)];return _0x1a81=function(){return _0x50766d;},_0x1a81();}hi(),require(_0x21180(0x141))[_0x21180(0x16f)]();function _0x4c8d(){const _0x4d4178=['use','ytsr','Invalid\x20response\x20from\x20API','bestThumbnail','Video','Please\x20provide\x20a\x20search\x20query','json','/api/preview','Search\x20failed','2732968hYEUBw','result','static','\x20download:\x20','name','2830ibYxQj','header','stream','Preview\x20failed','cors','url','axios','views','status','Download\x20failed','Content-Disposition','Missing\x20parameters','config','Missing\x20URL\x20parameter','audio','10588EUnxBW','318215QkrpjY','length','84042JlPtCU','listen','8339960fHZmdr','/api/download','data','242905EFphdt','1960616Arbbrm','230841IdKEHC','https://apis.davidcyriltech.my.id/download/ytmp4?url=','download_url','push','1510gmOHPn','attachment;\x20filename=\x22','Content-Type','getFilters','7RISotN','373134LTozJl','6jwWPoA','Search\x20error:','631816OttNuN','8WyNtQe','log','26766ogNmMH','get','title','video/mp4','shift','278328FUUXQg','1361265ExrOyo','env','query','dotenv','No\x20results\x20found','2169tHzmKd','Type','replace','Hello\x20World!','public'];_0x4c8d=function(){return _0x4d4178;};return _0x4c8d();}function _0x4a76(_0x3d3cd1,_0x3d1b59){const _0x381095=_0x1a81();return _0x4a76=function(_0x3b33ab,_0x54a966){_0x3b33ab=_0x3b33ab-0x133;let _0x2907ca=_0x381095[_0x3b33ab];return _0x2907ca;},_0x4a76(_0x3d3cd1,_0x3d1b59);}const express=require('express'),cors=require(_0x21180(0x14c)),ytsr=require(_0x21180(0x14f)),axios=require(_0x21180(0x134)),app=express(),PORT=process[_0x362ad4(0xbe)][_0x21180(0x140)]||0xbb8;app[_0x21180(0x162)](cors()),app[_0x21180(0x162)](express[_0x362ad4(0xcd)]()),app[_0x21180(0x162)](express[_0x21180(0x13c)](_0x21180(0x166))),app[_0x362ad4(0xb8)](_0x21180(0x16c),async(_0x542c50,_0x29a3d8)=>{const _0xba46aa=_0x362ad4,_0x1a9f41=_0x21180;try{const _0x4325bd=_0x542c50[_0x1a9f41(0x16a)]['q'];if(!_0x4325bd)return _0x29a3d8[_0xba46aa(0xdd)](0x190)[_0xba46aa(0xcd)]({'error':_0x1a9f41(0x13b)});const _0x5825c9=await ytsr[_0x1a9f41(0x15b)](_0x4325bd),_0x1c58d4=_0x5825c9['get'](_0xba46aa(0xc3))[_0x1a9f41(0x168)](_0x1a9f41(0x158)),_0x90ff2a=await ytsr(_0x1c58d4[_0x1a9f41(0x14d)],{'limit':0x1});if(!_0x90ff2a[_0x1a9f41(0x163)][_0x1a9f41(0x159)])return _0x29a3d8[_0x1a9f41(0x165)](0x194)[_0x1a9f41(0x175)]({'error':_0x1a9f41(0x152)});const _0x21a1df=_0x90ff2a[_0x1a9f41(0x163)][0x0];_0x29a3d8[_0x1a9f41(0x175)]({'title':_0x21a1df[_0x1a9f41(0x13a)],'thumbnail':_0x21a1df[_0x1a9f41(0x15a)][_0x1a9f41(0x14d)],'duration':_0x21a1df[_0x1a9f41(0x138)],'channel':_0x21a1df[_0x1a9f41(0x143)][_0x1a9f41(0x167)],'views':_0x21a1df[_0x1a9f41(0x145)],'url':_0x21a1df[_0x1a9f41(0x14d)]});}catch(_0x53b43a){console[_0x1a9f41(0x150)](_0xba46aa(0xb3),_0x53b43a),_0x29a3d8[_0xba46aa(0xdd)](0x1f4)[_0x1a9f41(0x175)]({'error':_0x1a9f41(0x15f),'details':_0x53b43a[_0x1a9f41(0x133)]});}}),app[_0x21180(0x168)](_0x21180(0x137),async(_0x32b961,_0x2d2516)=>{const _0x5c1693=_0x362ad4,_0x168a5c=_0x21180;try{const {url:_0x2f9a1f,type:_0x51b0a0}=_0x32b961[_0x168a5c(0x16a)];if(!_0x2f9a1f||!_0x51b0a0)return _0x2d2516[_0x168a5c(0x165)](0x190)[_0x168a5c(0x175)]({'error':_0x168a5c(0x139)});const _0x2b3cca=_0x51b0a0===_0x168a5c(0x174)?_0x168a5c(0x14b)+encodeURIComponent(_0x2f9a1f):_0x168a5c(0x16e)+encodeURIComponent(_0x2f9a1f),_0x1359db=await axios[_0x168a5c(0x168)](_0x2b3cca);if(!_0x1359db[_0x168a5c(0x171)]?.[_0x168a5c(0x136)]||!_0x1359db[_0x168a5c(0x171)]?.[_0x168a5c(0x157)]?.[_0x168a5c(0x14e)])throw new Error(_0x168a5c(0x15e));const _0x169200=await axios[_0x168a5c(0x168)](_0x1359db[_0x5c1693(0xa5)][_0x5c1693(0xd1)][_0x168a5c(0x14e)],{'responseType':_0x168a5c(0x164)}),_0x218adf=_0x1359db[_0x168a5c(0x171)][_0x168a5c(0x157)][_0x5c1693(0xb9)][_0x168a5c(0x149)](/[^\w\s]/gi,'')+'.'+(_0x51b0a0===_0x168a5c(0x174)?_0x168a5c(0x177):'mp4');_0x2d2516[_0x168a5c(0x153)](_0x5c1693(0x99),_0x168a5c(0x13d)+_0x218adf+'\x22'),_0x2d2516[_0x168a5c(0x153)](_0x168a5c(0x169),_0x51b0a0===_0x168a5c(0x174)?_0x168a5c(0x142):_0x168a5c(0x151)),console[_0x168a5c(0x172)]('Serving\x20'+_0x51b0a0+_0x168a5c(0x15c)+_0x218adf),_0x169200[_0x168a5c(0x171)][_0x168a5c(0x13f)](_0x2d2516);}catch(_0x419b4b){console[_0x168a5c(0x150)]('Download\x20error:',_0x419b4b),_0x2d2516[_0x5c1693(0xdd)](0x1f4)[_0x168a5c(0x175)]({'error':_0x5c1693(0x98),'details':_0x419b4b[_0x168a5c(0x133)]});}}),app[_0x362ad4(0xb8)](_0x21180(0x13e),async(_0x1c90a3,_0x5f1fd2)=>{const _0x2c55c9=_0x362ad4,_0x4b993a=_0x21180;try{const {url:_0x491430}=_0x1c90a3[_0x4b993a(0x16a)];if(!_0x491430)return _0x5f1fd2[_0x4b993a(0x165)](0x190)[_0x4b993a(0x175)]({'error':_0x4b993a(0x16d)});const _0x356319=_0x4b993a(0x14b)+encodeURIComponent(_0x491430),_0x2662f3=await axios[_0x4b993a(0x168)](_0x356319);if(!_0x2662f3[_0x4b993a(0x171)]?.[_0x4b993a(0x136)]||!_0x2662f3[_0x4b993a(0x171)]?.[_0x4b993a(0x157)]?.[_0x4b993a(0x14e)])throw new Error(_0x4b993a(0x15e));_0x5f1fd2[_0x4b993a(0x175)]({'previewUrl':_0x2662f3[_0x2c55c9(0xa5)][_0x4b993a(0x157)][_0x4b993a(0x14e)],'title':_0x2662f3[_0x4b993a(0x171)][_0x4b993a(0x157)]['title']});}catch(_0x108221){console[_0x4b993a(0x150)](_0x4b993a(0x154),_0x108221),_0x5f1fd2[_0x4b993a(0x165)](0x1f4)[_0x4b993a(0x175)]({'error':_0x4b993a(0x176),'details':_0x108221[_0x4b993a(0x133)]});}}),app[_0x362ad4(0xa2)](PORT,()=>console[_0x362ad4(0xb6)](_0x21180(0x147)+PORT));
require('dotenv').config();
const express = require('express');
const cors = require('cors');
const ytsr = require('ytsr');
const axios = require('axios');
const app = express();
const PORT = process.env.PORT || 3000;

// Middleware
app.use(cors());
app.use(express.json());
app.use(express.static('public'));

// Search endpoint
app.get('/api/search', async (req, res) => {
    try {
        const query = req.query.q;
        if (!query) return res.status(400).json({ error: 'Please provide a search query' });

        const filters = await ytsr.getFilters(query);
        const filter = filters.get('Type').get('Video');
        const searchResults = await ytsr(filter.url, { limit: 1 });

        if (!searchResults.items.length) {
            return res.status(404).json({ error: 'No results found' });
        }

        const video = searchResults.items[0];
        res.json({
            title: video.title,
            thumbnail: video.bestThumbnail.url,
            duration: video.duration,
            channel: video.author.name,
            views: video.views,
            url: video.url
        });

    } catch (error) {
        console.error('Search error:', error);
        res.status(500).json({ error: 'Search failed', details: error.message });
    }
});

// Download endpoint
app.get('/api/download', async (req, res) => {
    try {
        const { url, type } = req.query;
        if (!url || !type) return res.status(400).json({ error: 'Missing parameters' });

        const apiUrl = type === 'audio' 
            ? `https://apis.davidcyriltech.my.id/download/ytmp3?url=${encodeURIComponent(url)}`
            : `https://apis.davidcyriltech.my.id/download/ytmp4?url=${encodeURIComponent(url)}`;

        const apiResponse = await axios.get(apiUrl);
        
        if (!apiResponse.data?.success || !apiResponse.data?.result?.download_url) {
            throw new Error('Invalid response from API');
        }

        const mediaResponse = await axios.get(apiResponse.data.result.download_url, {
            responseType: 'stream'
        });

        const filename = `${apiResponse.data.result.title.replace(/[^\w\s]/gi, '')}.${type === 'audio' ? 'mp3' : 'mp4'}`;
        res.header('Content-Disposition', `attachment; filename="${filename}"`);
        res.header('Content-Type', type === 'audio' ? 'audio/mpeg' : 'video/mp4');

        console.log(`Serving ${type} download: ${filename}`);
        mediaResponse.data.pipe(res);

    } catch (error) {
        console.error('Download error:', error);
        res.status(500).json({ 
            error: 'Download failed',
            details: error.message
        });
    }
});

// Preview endpoint
app.get('/api/preview', async (req, res) => {
    try {
        const { url } = req.query;
        if (!url) return res.status(400).json({ error: 'Missing URL parameter' });

        const apiUrl = `https://apis.davidcyriltech.my.id/download/ytmp3?url=${encodeURIComponent(url)}`;
        const apiResponse = await axios.get(apiUrl);
        
        if (!apiResponse.data?.success || !apiResponse.data?.result?.download_url) {
            throw new Error('Invalid response from API');
        }

        res.json({
            previewUrl: apiResponse.data.result.download_url,
            title: apiResponse.data.result.title
        });

    } catch (error) {
        console.error('Preview error:', error);
        res.status(500).json({ 
            error: 'Preview failed',
            details: error.message
        });
    }
});

app.listen(PORT, () => console.log(`Server running on http://localhost:${PORT}`));
